---
title: "Analysis: Exploratory Data Analysis"
output: 
  html_document:
    theme: flatly
    toc: FALSE
---
<br>

---

## Introduction
This markdown imports the processed data and conducts the exploratory data analysis. Follow the processing markdowns in the `processing_code` folder to generate the processed data.

<br>

This analysis examines the predictors of allocation of FEMA funds during disaster declarations. In terms of the datasets, the two outcomes of interest are Requested Amount (`ReqAmt`) and Obligated Amount (`OblAmt`).

<br>

For each variable, the following steps will be completed:

1. Produce and print some numerical output (e.g. table, summary statistics)
2. Create a histogram or density plot (continuous variables only)
3. Scatterplot, boxplot, or other similar plots against the main outcome of interest
4. Any other exploration steps that may be useful.

The steps will be numbered for each variable as specified above.

---

## Required Packages
The following R packages are required for this script:

* here: for path setting
* tidyverse: for all packages in the Tidyverse (ggplot2, dyplr, tidyr, readr, purr, tibble, stringr, forcats)
* skimr: for data summarization
* summarytools: for overall dataframe summary
* ggplot2: for plotting data
* car: for creating QQ plots
* gtsummary: for creating tables for summary statistics / other numerical outputs
* scales: for percent calculation and axis formatting
* cowplot: for placing plots side by side
* table1: for making summary tables
* maps: for making maps

```{r libraries, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load required packages
library(here) #to set paths
library(tidyverse) #for data processing
library(skimr) #for data summarization
library(summarytools) #for overall dataframe summary
library(ggplot2) #for plotting data
library(car) #for creating QQ plots
library(gtsummary) #for creating tables
library(scales) #for percent calculation
library(cowplot) #for placing plots side by side
library(table1) #for making summary tables
library(maps) #for making maps

#global environment options
# formatting for script to avoid scientific notation output
options(scipen=999)

#set ggplot theme to classic
ggplot2::theme_set(theme_classic())

#center plot titles
theme_update(plot.title = element_text(hjust = 0.5))
```

---

## Load Processed Data
Load the data generated from the markdowns in the `processing_code` folder.
```{r load data}
#define file path
data_location <- here::here("data", "processed_data", "analysisdata.rds")

#load data
EDAdata <- readRDS(data_location)
```

---

## Data Overview
To better understand the data, let's use `summarytools` to better visualize the data.
```{r data overview}
summarytools::dfSummary(EDAdata)

skimr::skim(EDAdata)
```
Looking at the output of `summarytools::dfsummary()`

* There are 445 distinct disaster numbers across 2012 - 2021
* `OblAmt` ranges from -\$0 to \$4,408,424,297
* `ReqAmt` ranges from -\$0 to \$4,388,540,486
* There are 9 possible incident types
* There is a clear effect of both incident month and incident year

Before moving through the entire EDA, I want to create a secondary dataset with the outliers removed. This is the data actually used in the ML analysis, so this is the dataset that should be used for the EDA.
```{r outliers}
EDAdata_outliers <- EDAdata %>%
                      dplyr::filter(log(ReqAmt) > 0)
```

Let's dive a little deeper into each variable.

---

## Outcome of Interest: Requested FEMA Funds
The first of two primary outcomes of interest is the total amount of funds the state requested from the federal government for a disaster declaration.
```{r}
#summary statistics
base::summary(EDAdata_outliers$ReqAmt)

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = ReqAmt)) +
  geom_density()

#try a log transformation out of curiosity 
ggplot2::ggplot(data = EDAdata_outliers, aes(x = log(ReqAmt))) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = ReqAmt)) +
  geom_boxplot()

#crop to $1M to get a better idea
ggplot2::ggplot(data = EDAdata_outliers, aes(y = ReqAmt)) +
  geom_boxplot()

#log transformed boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = log(ReqAmt))) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$ReqAmt)
```
These outputs show the requested amounts do not follow a normal distribution, which is to be expected given the broad range of disasters. We may need to remove outliers in the analysis, but for now, we'll leave them to capture the true nature of disaster declarations. The largest outlier is likely Hurricane Maria. The log transformation does a better job of showing the distribution of the data, so we may need to consider an exponential model in the analysis. The transformed and untransformed figures suggest there are significant tails in the data. 

---

## Outcome of Interest: Obligated FEMA Funds
The alternative outcome of interest is the funding obligated from FEMA. While this may be the same as `ReqAmt` (especially for large-scale disasters), FEMA doesn't always pay the amount the states request.
```{r obligated funds}
#summary statistics
base::summary(EDAdata_outliers$OblAmt)

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = OblAmt)) +
  geom_density()

#try a log transformation out of curiosity 
ggplot2::ggplot(data = EDAdata_outliers, aes(x = log(OblAmt))) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = OblAmt)) +
  geom_boxplot()

#crop to $1M to get a better idea
ggplot2::ggplot(data = EDAdata_outliers, aes(y = OblAmt)) +
  geom_boxplot()

#log transformed boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = log(OblAmt))) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$OblAmt)
```
It appears that obligated funds and requested funds have similar distributions and characteristics. The same commentary about the requested funds analysis applies here as well.

Before moving on, I want to create a plot of Requested vs obligated Funds to understand the relationship between the two outcomes:
```{r}
#including all points
funds_comp <- EDAdata_outliers %>%
                ggplot2::ggplot(aes(x = log(ReqAmt), y = log(OblAmt))) +
                         geom_smooth(color = "#440154",
                                     size = 2) +
                         geom_point(color = "#1f9e89",
                                    alpha = 0.5) +
                         scale_y_continuous(expand = c(0,0),
                                            limits = c(0, NA)) +
                         scale_x_continuous(expand = c(0,0),
                                            limits = c(0, NA)) +
                         labs(x = "log(Requested Funding)",
                              y = "log(Obligated Funding)")

funds_comp

#save file
funds_comp_fig_file = here("results","funds_comp.png")
ggsave(filename = funds_comp_fig_file, plot = funds_comp)
```

I also want a density plot of both log-transformed outcomes on one plot, so that can go here as well.
```{r}
#convert to long format in order to be able to plot both outcomes with same variable
data_long <- gather(EDAdata_outliers, FundType, funds, ReqAmt:OblAmt, factor_key=TRUE)
data_long

#change labels
levels(data_long$FundType) <- c("Requested Amount", "Obligated Amount")

#now usual ggplot2 density plot
funds_density <- ggplot2::ggplot(data = data_long, aes(x = log(funds), color = FundType, fill = FundType)) +
                          geom_density(alpha = 0.4) +
                          facet_wrap(~ FundType) +
                          scale_fill_manual(values = c("#6ece58", "#26828e")) +
                          scale_color_manual(values = c("#6ece58", "#26828e")) +
                          labs(x = "Log(Funding)",
                               y = "Density") +
                          theme(legend.position="none")

funds_density

#save file
funds_density_fig_file = here("results","funds_density.png")
ggsave(filename = funds_density_fig_file, plot = funds_density)

```

---

## Predictor: State
```{r}
#frequency table since it's categorical
#hide NAs because there are no NAs
summarytools::freq(EDAdata_outliers$state, report.nas = FALSE)

#examine graphical relationship with outcomes
#include a jitter function to have a better idea of number of measurements and distribution
#filter top 5 states
#start with obligated amount
obl_fig_state <- EDAdata_outliers %>%
                    dplyr::add_count(state) %>%
                    dplyr::filter(dplyr::dense_rank(-n) < 5) %>%
                    ggplot2::ggplot(aes(x = state, y = OblAmt)) +
                      geom_boxplot(color = "#440154") +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#26828e") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      labs(x = "State or Territory",
                           y = "Obligated FEMA Funds")
obl_fig_state

#repeat for requested funds
req_fig_state <- EDAdata_outliers %>%
                    dplyr::add_count(state) %>%
                    dplyr::filter(dplyr::dense_rank(-n) < 6) %>%
                    ggplot2::ggplot(aes(x = state, y = ReqAmt)) +
                      geom_boxplot(color = "#440154") +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#6ece58") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      labs(x = " " ,
                           y = "Requested FEMA Funds")
req_fig_state

#combine into one plot
plot_states <- cowplot::plot_grid(req_fig_state, 
                                     obl_fig_state,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_states

title_state <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds For Five Most Disaster Prone States",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme(plot.margin = margin(0, 0, 0, 7))

plot_states_funds <- cowplot::plot_grid(
                              title_state, plot_states,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
plot_states_funds

#save file
states_fig_file = here("results","states-funds.png")
ggsave(filename = states_fig_file, plot = plot_states_funds)

#create a table where columns represent requested and obligated funds and rows are 5 most disaster-prone states
decs_state_5 <- EDAdata_outliers %>%
                    dplyr::add_count(state) %>%
                    dplyr::filter(dense_rank(-n) < 6) %>%
                    gtsummary::select(state, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = state,
                      label = list(state ~ "State or Territory",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2", "stat_3", "stat_4", "stat_5") ~ "**State**") %>%
                    gtsummary::modify_caption("**Table 4. FEMA Funding for 5 Most Disaster-Prone States 2012 - 2021**") %>%
                    gtsummary::bold_labels()
decs_state_5

#save file
decs_state_file = here("results", "decs-state-5.Rds")
saveRDS(decs_state_5, file = decs_state_file)
```

---

## Predictor: Incident Year
```{r}
#summary statistics since it's continuous
base::summary(EDAdata_outliers$IncidentYear)

#examine graphical relationship with outcomes

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = IncidentYear)) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = IncidentYear)) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$IncidentYear)

#histogram distribution
year_hist <- EDAdata_outliers %>% 
               ggplot2::ggplot(aes(x=IncidentYear)) + 
                        geom_bar(fill="#482878") + 
                        scale_x_continuous(breaks = seq(2012, 2021, by = 1)) +
                        scale_y_continuous(expand = c(0, 0), limits = c(0, 125)) +
                        geom_text(stat='count', aes(label=..count..), vjust=-1) +
                        labs(x = "Incident Year",
                             y = "Number of Declarations",
                             title = "Disaster Declarations per Year (2012 - 2021)")
year_hist

#save file
year_fig_file = here("results","incidentyear.png")
ggsave(filename = year_fig_file, plot = year_hist)

#examine graphical relationship with outcomes of interest
#look at total cost per incident year
req_fig_year <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = IncidentYear)) +
                      geom_bar(aes(y = ReqAmt),
                               stat = "identity",
                               fill = "#6ece58") +
                      scale_y_continuous(expand = c(0, 0), 
                                         labels = scales::dollar_format()) +
                      scale_x_continuous(breaks = seq(2012, 2021, by = 1)) +
                      labs(x = "Incident Year",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_year

#repeat for obligated funds
obl_fig_year <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = IncidentYear)) +
                      geom_bar(aes(y = OblAmt),
                               stat = "identity",
                               fill = "#26828e") +
                      scale_y_continuous(expand = c(0, 0),
                                         labels = scales::dollar_format()) +
                      scale_x_continuous(breaks = seq(2012, 2021, by = 1)) +
                      labs(x = "Incident Year",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_year

#combine into one plot
plot_col <- cowplot::plot_grid(req_fig_year, 
                                     obl_fig_year,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_col


title1 <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds Per Year",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme( plot.margin = margin(0, 0, 0, 7))

funds_fig_year <- cowplot::plot_grid(
                              title1, plot_col,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
funds_fig_year

#save file
funds_year_fig_file = here("results","funds-years.png")
ggsave(filename = funds_year_fig_file, plot = funds_fig_year)

#create a table where columns represent requested and obligated funds and rows are 5 most disaster-prone states
decs_year_3 <- EDAdata_outliers %>%
                    dplyr::add_count(IncidentYear) %>%
                    dplyr::filter(dense_rank(-n) < 4) %>%
                    gtsummary::select(IncidentYear, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = IncidentYear,
                      label = list(IncidentYear ~ "Year",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Year**") %>%
                    gtsummary::modify_caption("**Table 2. FEMA Funding for the 3 Costliest Years (2012 - 2021)**") %>%
                    gtsummary::bold_labels()
decs_year_3

#save file
decs_year_file = here("results", "decs-year-3.Rds")
saveRDS(decs_year_3, file = decs_year_file)
```

---

## Incident Month
```{r}
#frequency table since it's categorical
#hide NAs because there are no NAs
summarytools::freq(EDAdata_outliers$IncidentMonth, report.nas = FALSE)

#examine graphical relationship with outcomes
#include a jitter function to have a better idea of number of measurements and distribution
#filter top 5 states
#start with obligated amount
obl_fig_month <- EDAdata_outliers %>%
                    dplyr::add_count(state) %>%
                    dplyr::filter(dplyr::dense_rank(-n) < 5) %>%
                    ggplot2::ggplot(aes(x = IncidentMonth, y = OblAmt)) +
                      geom_boxplot(color = "#440154") +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#26828e") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      labs(x = "Incident Month",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_month

#repeat for requested funds
req_fig_month <- EDAdata_outliers %>%
                    dplyr::add_count(state) %>%
                    dplyr::filter(dplyr::dense_rank(-n) < 6) %>%
                    ggplot2::ggplot(aes(x = IncidentMonth, y = ReqAmt)) +
                      geom_boxplot(color = "#440154") +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#6ece58") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      labs(x = " " ,
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_month

#combine into one plot
plot_month <- cowplot::plot_grid(req_fig_month, 
                                     obl_fig_month,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_month

title_month <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds By Month",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme(plot.margin = margin(0, 0, 0, 7))

plot_month_funds <- cowplot::plot_grid(
                              title_month, plot_month,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
plot_month_funds

#save file
month_fig_file = here("results","month-funds.png")
ggsave(filename = month_fig_file, plot = plot_month_funds)

#create a table where columns represent requested and obligated funds and rows are 5 most disaster-prone states
decs_month_5 <- EDAdata_outliers %>%
                    dplyr::add_count(IncidentMonth) %>%
                    dplyr::filter(dense_rank(-n) < 6) %>%
                    gtsummary::select(IncidentMonth, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = IncidentMonth,
                      label = list(IncidentMonth ~ "Incident Month",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2", "stat_3", "stat_4", "stat_5") ~ "**Incident Month**") %>%
                    gtsummary::modify_caption("**Table 4. FEMA Funding by Month 2012 - 2021**") %>%
                    gtsummary::bold_labels()
decs_month_5

#save file
decs_month_file = here("results", "decs-month-5.Rds")
saveRDS(decs_month_5, file = decs_month_file)
```

---

## Predictor: Declaration Type
```{r}
#frequency table since it's categorical
#hide NAs because there are no NAs
summarytools::freq(EDAdata_outliers$declarationType, report.nas = FALSE)

#examine graphical relationship with outcomes
#include a jitter function to have a better idea of number of measurements and distribution
#start with obligated amount
obl_fig_DT <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = declarationType, y = OblAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#26828e") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      scale_x_discrete(labels = c("Major Disaster Declaration", "Emergency Declaration")) + 
                      labs(x = "Declaration Type",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_DT

#repeat for requested funds
req_fig_DT <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = declarationType, y = ReqAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#6ece58") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      scale_x_discrete(labels = c("Major Disaster Declaration", "Emergency Declaration")) + 
                      labs(x = " ",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_DT

#combine into one plot
plot_DT <- cowplot::plot_grid(req_fig_DT, 
                                     obl_fig_DT,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_DT

title_DT <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds By Declaration Type",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme(plot.margin = margin(0, 0, 0, 7))

plot_DT_funds <- cowplot::plot_grid(
                              title_DT, plot_DT,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
plot_DT_funds

#save file
DT_fig_file = here("results","DT-funds.png")
ggsave(filename = DT_fig_file, plot = plot_DT_funds)

#create a table where rows represent requested and obligated funds and columns are declaration type
decs_dtype <- EDAdata_outliers %>%
                    gtsummary::select(declarationType, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = declarationType,
                      label = list(declarationType ~ "Type",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_header(update = list(
                                               stat_1 ~ "**Major Disaster**",
                                               stat_2 ~ "**Emergency**")) %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2") ~ "**Type**") %>%
                    gtsummary::modify_caption("**Table 4. FEMA Funding for Declaration Types 2012 - 2021**") %>%
                    gtsummary::bold_labels()
decs_dtype

#save file
decs_dtype_file = here("results", "decs-DT.Rds")
saveRDS(decs_dtype, file = decs_dtype_file)
```

---

## Predictor: Incident Type
```{r}
#frequency table since it's categorical
#hide NAs because there are no NAs
summarytools::freq(EDAdata_outliers$incidentType, report.nas = FALSE)

#examine graphical relationship with outcomes
#include a jitter function to have a better idea of number of measurements and distribution
#start with obligated amount
obl_fig_IT <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = incidentType, y = OblAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#26828e") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      labs(x = "Incident Type",
                           y = "Funds ($)",
                           subtitle = "Obligated") +
                      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
obl_fig_IT

#repeat for requested funds
req_fig_IT <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = incidentType, y = ReqAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#6ece58") +
                      scale_y_continuous(labels = scales::dollar_format()) + 
                      labs(x = " ",
                           y = "Funds ($)",
                           subtitle = "Requested") +
                      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
req_fig_IT

#combine into one plot
plot_IT <- cowplot::plot_grid(req_fig_IT, 
                                     obl_fig_IT,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_IT

title_IT <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds By Incident Type",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme(plot.margin = margin(0, 0, 0, 7))

plot_IT_funds <- cowplot::plot_grid(
                              title_IT, plot_IT,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
plot_IT_funds

#save file
IT_fig_file = here("results","IT-funds.png")
ggsave(filename = IT_fig_file, plot = plot_IT_funds)

#create a table where rows represent requested and obligated funds and columns are declaration type
decs_itype3 <- EDAdata %>%
                    dplyr::add_count(incidentType) %>%
                    dplyr::filter(dense_rank(-n) < 4) %>%
                    gtsummary::select(incidentType, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = incidentType,
                      label = list(incidentType ~ "Type",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Type**") %>%
                    gtsummary::modify_caption("**Table 4. FEMA Funding for Declaration Types 2012 - 2021**") %>%
                    gtsummary::bold_labels()
decs_itype3

#save file
decs_itype3_file = here("results", "decs-IT-3.Rds")
saveRDS(decs_itype3, file = decs_itype3_file)
```

---

## Predictor: Incident Duration
```{r}
#convert class to numeric
EDAdata_outliers$IncidentDuration <- as.numeric(EDAdata_outliers$IncidentDuration, units="days")

#summary statistics since it's continuous
base::summary(EDAdata_outliers$IncidentDuration)
#NAs are ongoing events

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = IncidentDuration)) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = IncidentDuration)) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$IncidentDuration)

#examine graphical relationship with outcomes of interest
#look at total cost per incident month
req_fig_dur <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = IncidentDuration)) +
                      geom_point(aes(y = ReqAmt),
                                 color = "#6ece58",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Incident Duration (Days)",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_dur

#repeat for obligated funds
obl_fig_dur <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = IncidentDuration)) +
                      geom_point(aes(y = OblAmt),
                                 color = "#26828e",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Incident Duration (Days)",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_dur

#combine into one plot
plot_col2 <- cowplot::plot_grid(req_fig_dur, 
                                     obl_fig_dur,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_col2


title3 <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds by Incident Duration (Under $1B)",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme( plot.margin = margin(0, 0, 0, 7))

funds_fig_dur <- cowplot::plot_grid(
                              title3, plot_col2,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
funds_fig_dur

#save file
funds_dur_fig_file = here("results","funds-dur.png")
ggsave(filename = funds_dur_fig_file, plot = funds_fig_dur)
```

---

## Predictor: Population
```{r}
#convert class to numeric
EDAdata_outliers$Population <- as.numeric(gsub(",", "", EDAdata_outliers$Population))

#summary statistics since it's continuous
base::summary(EDAdata_outliers$Population)

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = Population)) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = Population)) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$Population)

#examine graphical relationship with outcomes of interest
#look at total cost per pop
req_fig_pop <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = Population)) +
                      geom_point(aes(y = ReqAmt),
                                 color = "#6ece58",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      scale_x_continuous(label = comma,
                                         limits = c(0, 40000000)) +
                      labs(x = "State Population",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_pop

#repeat for obligated funds
obl_fig_pop <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = Population)) +
                      geom_point(aes(y = OblAmt),
                                 color = "#26828e",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      scale_x_continuous(label = comma,
                                         limits = c(0, 40000000)) +
                      labs(x = "State Population",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_pop

#combine into one plot
plot_col3 <- cowplot::plot_grid(req_fig_pop, 
                                     obl_fig_pop,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_col3


title4 <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs obligated FEMA funds by State Population (Under $1B)",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme( plot.margin = margin(0, 0, 0, 7))

funds_fig_pop <- cowplot::plot_grid(
                              title4, plot_col3,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
funds_fig_pop

#save file
funds_pop_fig_file = here("results","funds-pop.png")
ggsave(filename = funds_pop_fig_file, plot = funds_fig_pop)
```

---

## Predictor: Total Number of Agencies Involved
```{r}
#summary statistics since it's continuous
base::summary(EDAdata_outliers$TotalAgencies)

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = TotalAgencies)) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = TotalAgencies)) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$TotalAgencies)

#examine graphical relationship with outcomes of interest
#look at total cost per incident month
req_fig_ag <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = TotalAgencies)) +
                      geom_point(aes(y = ReqAmt),
                                 color = "#6ece58",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Number of Federal Agencies",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_ag

#repeat for obligated funds
obl_fig_ag <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = TotalAgencies)) +
                      geom_point(aes(y = OblAmt),
                                 color = "#26828e",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Number of Federal Agencies",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_ag

#combine into one plot
plot_col4 <- cowplot::plot_grid(req_fig_ag, 
                                     obl_fig_ag,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_col4


title5 <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs obligated FEMA funds by number of federal agencies (Under $1B)",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme( plot.margin = margin(0, 0, 0, 7))

funds_fig_ag <- cowplot::plot_grid(
                              title5, plot_col4,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
funds_fig_ag

#save file
funds_ag_fig_file = here("results","funds-ag.png")
ggsave(filename = funds_ag_fig_file, plot = funds_fig_ag)
```

---

## Predictor: Number of Counties
```{r}
#summary statistics since it's continuous
base::summary(EDAdata_outliers$Counties)

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = Counties)) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = Counties)) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$Counties)

#examine graphical relationship with outcomes of interest
#look at total cost per incident month
req_fig_count <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = Counties)) +
                      geom_point(aes(y = ReqAmt),
                                 color = "#6ece58",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Number of Counties",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_count

#repeat for obligated funds
obl_fig_count <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = Counties)) +
                      geom_point(aes(y = OblAmt),
                                 color = "#26828e",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Number of Counties",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_count

#combine into one plot
plot_col5 <- cowplot::plot_grid(req_fig_count, 
                                     obl_fig_count,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_col5


title6 <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs obligated FEMA funds by number of counties (Under $1B)",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme( plot.margin = margin(0, 0, 0, 7))

funds_fig_count <- cowplot::plot_grid(
                              title6, plot_col5,
                              ncol = 1,
                              rel_heights = c(0.1, 1))
funds_fig_count

#save file
funds_count_fig_file = here("results","funds-count.png")
ggsave(filename = funds_count_fig_file, plot = funds_fig_count)
```

---

## Predictor: FEMA Cost Share Average
```{r}
#summary statistics since it's continuous
base::summary(EDAdata_outliers$FEMACSAvg)

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = FEMACSAvg)) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = FEMACSAvg)) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$FEMACSAvg)

#examine graphical relationship with outcomes of interest
#look at total cost per incident month
req_fig_cs <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = FEMACSAvg)) +
                      geom_point(aes(y = ReqAmt),
                                 color = "#6ece58",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Average FEMA Cost Share",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_cs

#repeat for obligated funds
obl_fig_cs <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = FEMACSAvg)) +
                      geom_point(aes(y = OblAmt),
                                 color = "#26828e",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Average FEMA Cost Share",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_cs

#combine into one plot
plot_col6 <- cowplot::plot_grid(req_fig_cs, 
                                     obl_fig_cs,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_col6


title7 <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs obligated FEMA funds by avg FEMA cost share (Under $1B)",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme( plot.margin = margin(0, 0, 0, 7))

funds_fig_cs <- cowplot::plot_grid(
                              title7, plot_col6,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
funds_fig_cs

#save file
funds_cs_fig_file = here("results","funds-cs.png")
ggsave(filename = funds_cs_fig_file, plot = funds_fig_cs)
```

---

## Predictor: IH Program
```{r}
#convert to factor
EDAdata_outliers$IH <- as.factor(EDAdata_outliers$IH)

#frequency table since it's categorical
#hide NAs because there are no NAs
summarytools::freq(EDAdata_outliers$IH, report.nas = FALSE)

#examine graphical relationship with outcomes
#include a jitter function to have a better idea of number of measurements and distribution
#start with obligated amount
obl_fig_IH <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = IH, y = OblAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#26828e") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      scale_x_discrete(labels = c("Not Awarded", "Awarded")) +
                      labs(x = "IH Program",
                           y = "Funds ($)",
                           subtitle = "Obligated") 
obl_fig_IH

#repeat for requested funds
req_fig_IH <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = IH, y = ReqAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#6ece58") +
                      scale_y_continuous(labels = scales::dollar_format()) + 
                      scale_x_discrete(labels = c("Not Awarded", "Awarded")) +
                      labs(x = " ",
                           y = "Funds ($)",
                           subtitle = "Requested") 
req_fig_IH

#combine into one plot
plot_IH <- cowplot::plot_grid(req_fig_IH, 
                                     obl_fig_IH,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_IH

title_IH <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds By IH Program Awardance",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme(plot.margin = margin(0, 0, 0, 7))

plot_IH_funds <- cowplot::plot_grid(
                              title_IH, plot_IH,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
plot_IH_funds

#save file
IH_fig_file = here("results","IH-funds.png")
ggsave(filename = IH_fig_file, plot = plot_IH_funds)

#create a table where rows represent requested and obligated funds and columns are declaration type
decs_ih <- EDAdata_outliers %>%
                    gtsummary::select(IH, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = IH,
                      label = list(IH ~ "Individuals / Households Program",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_header(update = list(
                                               stat_1 ~ "**Not Awarded**",
                                               stat_2 ~ "**Awarded**")) %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2") ~ "**Individuals/Households Program**") %>%
                    gtsummary::modify_caption("**Table 5. FEMA Funding by IH Program Awardance 2012 - 2021**") %>%
                    gtsummary::bold_labels()
decs_ih

#save file
decs_ih_file = here("results", "decs-IH.Rds")
saveRDS(decs_ih, file = decs_ih_file)
```

---

## Predictor: PA Program
```{r}
#convert to factor
EDAdata_outliers$PA <- as.factor(EDAdata_outliers$PA)

#frequency table since it's categorical
#hide NAs because there are no NAs
summarytools::freq(EDAdata_outliers$PA, report.nas = FALSE)

#examine graphical relationship with outcomes
#include a jitter function to have a better idea of number of measurements and distribution
#start with obligated amount
obl_fig_PA <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = PA, y = OblAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#26828e") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      scale_x_discrete(labels = c("Not Awarded", "Awarded")) +
                      labs(x = "PA Program",
                           y = "Funds ($)",
                           subtitle = "FEMA funds obligated when PA program is awarded") 
obl_fig_PA

#repeat for requested funds
req_fig_PA <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = PA, y = ReqAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#6ece58") +
                      scale_y_continuous(labels = scales::dollar_format()) + 
                      scale_x_discrete(labels = c("Not Awarded", "Awarded")) +
                      labs(x = " ",
                           y = "Funds ($)",
                           title = "Requested") +
                      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
req_fig_PA

#combine into one plot
plot_PA <- cowplot::plot_grid(req_fig_PA, 
                                     obl_fig_PA,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_PA

title_PA <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds By PA Program Awardance",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme(plot.margin = margin(0, 0, 0, 7))

plot_PA_funds <- cowplot::plot_grid(
                              title_PA, plot_PA,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
plot_PA_funds

#save file
PA_fig_file = here("results","PA-funds.png")
ggsave(filename = PA_fig_file, plot = plot_PA_funds)

#create a table where rows represent requested and obligated funds and columns are declaration type
decs_pa <- EDAdata_outliers %>%
                    gtsummary::select(PA, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = PA,
                      label = list(PA ~ "Public Assistance Program",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_header(update = list(
                                               stat_1 ~ "**Not Awarded**",
                                               stat_2 ~ "**Awarded**")) %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2") ~ "**Public Assistance Program**") %>%
                    gtsummary::modify_caption("**Table 6. FEMA Funding by PA Program Awardance 2012 - 2021**") %>%
                    gtsummary::bold_labels()
decs_pa

#save file
decs_pa_file = here("results", "decs-PA.Rds")
saveRDS(decs_pa, file = decs_pa_file)
```

---

## Predictor: HM Program
```{r}
#convert to factor
EDAdata_outliers$HM <- as.factor(EDAdata_outliers$HM)

#frequency table since it's categorical
#hide NAs because there are no NAs
summarytools::freq(EDAdata_outliers$HM, report.nas = FALSE)

#examine graphical relationship with outcomes
#include a jitter function to have a better idea of number of measurements and distribution
#start with obligated amount
obl_fig_HM <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = HM, y = OblAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#26828e") +
                      scale_y_continuous(labels = scales::dollar_format()) +
                      scale_x_discrete(labels = c("Not Awarded", "Awarded")) +
                      labs(x = "HM Program",
                           y = "Funds ($)",
                           subtitle = "Obligated") 
obl_fig_HM

#repeat for requested funds
req_fig_HM <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = HM, y = ReqAmt)) +
                      geom_boxplot() +
                      geom_jitter(alpha = 0.5, width = 0.2, height = 0.2, color = "#6ece58") +
                      scale_y_continuous(labels = scales::dollar_format()) + 
                      scale_x_discrete(labels = c("Not Awarded", "Awarded")) +
                      labs(x = " ",
                           y = "Funds ($)",
                           subtitle = "Requested") 
req_fig_HM

#combine into one plot
plot_HM <- cowplot::plot_grid(req_fig_HM, 
                                     obl_fig_HM,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_HM

title_HM <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs Obligated FEMA Funds By HM Program Awardance",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme(plot.margin = margin(0, 0, 0, 7))

plot_HM_funds <- cowplot::plot_grid(
                              title_HM, plot_HM,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
plot_HM_funds

#save file
PA_fig_file = here("results","PA-funds.png")
ggsave(filename = PA_fig_file, plot = plot_PA_funds)

#create a table where rows represent requested and obligated funds and columns are declaration type
decs_hm <- EDAdata %>%
                    gtsummary::select(HM, ReqAmt, OblAmt) %>%
                    gtsummary::tbl_summary(
                      by = HM,
                      label = list(HM ~ "Hazard Mitigation Program",
                                   ReqAmt ~ "Requested Funds",
                                   OblAmt ~ "Obligated Funds"),
                      statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
                    gtsummary::modify_header(label ~ "**Variable**") %>% 
                    gtsummary::modify_header(update = list(
                                               stat_1 ~ "**Not Awarded**",
                                               stat_2 ~ "**Awarded**")) %>% 
                    gtsummary::modify_spanning_header(c("stat_1", "stat_2") ~ "**Hazard Mitigation Program**") %>%
                    gtsummary::modify_caption("**Table 7. FEMA Funding by HM Program Awardance 2012 - 2021**") %>%
                    gtsummary::bold_labels()
decs_hm

#save file
decs_hm_file = here("results", "decs-HM.Rds")
saveRDS(decs_hm, file = decs_hm_file)
```

---

## Predictor: Response Duration
```{r}
#summary statistics since it's continuous
base::summary(EDAdata_outliers$ResponseDays)
#NAs are ongoing events

#density plot
ggplot2::ggplot(data = EDAdata_outliers, aes(x = ResponseDays)) +
  geom_density()

#normal boxplot
ggplot2::ggplot(data = EDAdata_outliers, aes(y = ResponseDays)) +
  geom_boxplot()

##QQ plot
car::qqPlot(EDAdata_outliers$ResponseDays)

#examine graphical relationship with outcomes of interest
req_fig_resp <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = ResponseDays)) +
                      geom_point(aes(y = ReqAmt),
                                 color = "#6ece58",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = " ",
                           y = "Funds ($)",
                           subtitle = "Requested")
req_fig_resp

#repeat for obligated funds
obl_fig_resp <- EDAdata_outliers %>%
                    ggplot2::ggplot(aes(x = ResponseDays)) +
                      geom_point(aes(y = OblAmt),
                                 color = "#26828e",
                                 show.legend = FALSE) +
                      scale_y_continuous(expand = c(0, 0),
                                         limits = c(0, 1000000000),
                                         labels = scales::dollar_format()) +
                      labs(x = "Response Duration (Days)",
                           y = "Funds ($)",
                           subtitle = "Obligated")
obl_fig_resp

#combine into one plot
plot_col7 <- cowplot::plot_grid(req_fig_resp, 
                                     obl_fig_resp,
                                     ncol = 1,
                                     align = "v",
                                     rel_heights = c(0.5,0.5))
plot_col7


title8 <- cowplot::ggdraw() + 
                    draw_label(
                      "Requested vs obligated FEMA funds by response duration (Under $1B)",
                      fontface = 'bold',
                      x = 0,
                      hjust = 0) +
                    theme( plot.margin = margin(0, 0, 0, 7))

funds_fig_resp <- cowplot::plot_grid(
                              title8, plot_col7,
                              ncol = 1,
                              # rel_heights values control vertical title margins
                              rel_heights = c(0.1, 1))
funds_fig_resp

#save file
funds_resp_fig_file = here("results","funds-resp.png")
ggsave(filename = funds_resp_fig_file, plot = funds_fig_resp)
```

---

## Create "Table 1"
Make the summary table for the manuscript. Variables to include:

* state
* IncidentYear
* IncidentMonth
* declarationType
* incidentType
* IncidentDuration
* ResponseDays
* IH Percent
* PA Percent
* HM Percent
* Population
* Counties
* TotalAgencies
* FEMACSAvg

```{r}
#specify units
table1::units(EDAdata$IncidentDuration) <- "days"
table1::units(EDAdata$ResponseDays) <- "days"

#create table
table1 <- table1::table1(~ ReqAmt + OblAmt + FEMACSAvg + TotalAgencies + IH_pct + PA_pct + HM_pct + ResponseDays +
                           IncidentDuration + IncidentMonth + IncidentYear + incidentType + declarationType +
                           FEMARegion + Counties + Population, data = EDAdata)
table1

#save file
table1_file = here("results", "table1.Rds")
saveRDS(table1, file = table1_file)
```

---

# Map Figure
Make the following four maps:

1. FEMA Regions
2. Density by total number of declarations
3. Density by total requested funds
4. Density by obligated funds

```{r}
#pull geographic boundaries from maps package
MainStates <- map_data("state")

#fix capitalization issue in map data
MainStates$name <- str_to_title(MainStates$region)

#create summary df by state for EDAdata_analysis
#count number of declarations per state
EDA_sum_1 <- EDAdata_outliers %>%
                dplyr::group_by(name,
                                state,
                                latitude,
                                longitude,
                                Population,
                                Counties,
                                FEMARegion) %>%
                dplyr::count(state)

#find total of requested and obligated funds
EDA_sum_2 <- EDAdata_outliers %>%
                dplyr::group_by(name) %>%
                dplyr::summarize(RequestedAmt = sum(ReqAmt),
                                 ObligatedAmt = sum(OblAmt))

#combine the two
EDA_sums <- inner_join(EDA_sum_1, EDA_sum_2, by = "name")

#merge MainStates and EDAdata_outliers
MergedStates <- inner_join(MainStates, EDA_sums, by = "name")

#rename count variable
MapsData <- MergedStates %>%
                  dplyr::mutate(NumDecs = n) %>%
                  dplyr::select(-n)

#create map with FEMA Regions
map1 <- ggplot(MapsData, aes(x = long, 
                             y = lat, 
                             group = group)) +
      geom_polygon(aes(fill = FEMARegion), colour = alpha("white", 1 / 2), size = 0.2) +
      geom_polygon(data = MergedStates, colour = "white", fill = NA) +
      coord_fixed() +
      scale_fill_manual(values = c("#fde725", "#b5de2b", "#6ece58", "#35b779", "#1f9e89", "#26828e", "#31688e",
                                   "#3e4989", "#482878", "#440154")) +
      theme(axis.line = element_blank(), axis.text = element_blank(),
            axis.ticks = element_blank(), axis.title = element_blank())
map1

#save file
map1_fig_file = here("results","map1.png")
ggsave(filename = map1_fig_file, plot = map1)

#create map with number of declarations
map2 <- ggplot(MapsData, aes(x = long, 
                             y = lat, 
                             group = group)) +
      geom_polygon(aes(fill = NumDecs), colour = alpha("white", 1 / 2), size = 0.2) +
      geom_polygon(data = MergedStates, colour = "white", fill = NA) +
      coord_fixed() +
      scale_fill_viridis_c(option = "D",
                           name = "Number of Declarations") +
      theme(axis.line = element_blank(), axis.text = element_blank(),
            axis.ticks = element_blank(), axis.title = element_blank())
map2

#save file
map2_fig_file = here("results","map2.png")
ggsave(filename = map2_fig_file, plot = map2)

#create map with requested amount
map3 <- ggplot(MapsData, aes(x = long, 
                             y = lat, 
                             group = group)) +
      geom_polygon(aes(fill = RequestedAmt), colour = alpha("white", 1 / 2), size = 0.2) +
      geom_polygon(data = MergedStates, colour = "white", fill = NA) +
      coord_fixed() +
      scale_fill_viridis_c(option = "D",
                           labels=scales::dollar_format(),
                           name = "Requested Amount") +
      theme(axis.line = element_blank(), axis.text = element_blank(),
            axis.ticks = element_blank(), axis.title = element_blank())
map3

#save file
map3_fig_file = here("results","map3.png")
ggsave(filename = map3_fig_file, plot = map3)

#create map with obligated amount
map4 <- ggplot(MapsData, aes(x = long, 
                             y = lat, 
                             group = group)) +
      geom_polygon(aes(fill = ObligatedAmt), colour = alpha("white", 1 / 2), size = 0.2) +
      geom_polygon(data = MergedStates, colour = "white", fill = NA) +
      coord_fixed() +
      scale_fill_viridis_c(option = "D",
                           labels=scales::dollar_format(),
                           name = "Obligated Amount") +
      theme(axis.line = element_blank(), axis.text = element_blank(),
            axis.ticks = element_blank(), axis.title = element_blank())
map4

#save file
map4_fig_file = here("results","map4.png")
ggsave(filename = map4_fig_file, plot = map4)
```

